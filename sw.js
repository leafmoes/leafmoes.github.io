(()=>{const e="ArtmoeBlogCache",t="https://id.v3/",n=n=>caches.open(e).then((e=>e.put(t,new Response(JSON.stringify(n))))),s=()=>caches.match(t).then((e=>e?.json()));self.addEventListener("install",(()=>{self.skipWaiting()})),self.addEventListener("activate",(e=>e.waitUntil(clients.claim())));let r={simple:{clean:!0,search:!1,match:e=>"blog.artmoe.top"===e.host&&e.pathname.match(/\.(woff2|woff|ttf|cur)$/)}},o=e=>{if(e.startsWith("https://cdn.jsdelivr.net")){return{timeout:3e3,list:["https://jsd.cdn.zzko.cn"+new URL(e).pathname,e]}}};const a=(e,t,n=null)=>{const s={cache:t?"no-store":"default",mode:"cors",credentials:"same-origin"};if(!n&&!(n=o(e.url)))return fetch(e,s);const r=n.list,a=new Array(r.length),c=t=>fetch(new Request(r[t],e),Object.assign({signal:(a[t]=new AbortController).signal},s)).then((e=>h(e)?{r:e,i:t}:Promise.reject()));return new Promise(((t,s)=>{let o=!0;const h=()=>{o=!1,Promise.any([l,...Array.from({length:r.length-1},((e,t)=>t+1)).map((e=>c(e)))]).then((e=>{for(let t=0;t!==r.length;++t)t!==e.i&&a[t].abort();t(e.r)})).catch((()=>s(`请求 ${e.url} 失败`)))},i=setTimeout(h,n.timeout),l=c(0).then((e=>{o&&(clearTimeout(i),t(e.r))})).catch((()=>(o&&(clearTimeout(i),h()),Promise.reject())))}))},h=e=>e.ok||[301,302,307,308].includes(e.status),c=new Map;self.addEventListener("fetch",(t=>{let n=t.request,s=new URL(n.url);if("GET"!==n.method||!n.url.startsWith("http"))return;let r=s.hostname+s.pathname+s.search,l=c.get(r);if(l)return t.respondWith(new Promise(((e,t)=>{c.get(r).push({s:e,e:t})})));c.set(r,l=[]);const u=e=>t.respondWith(e.then((e=>{for(let t of l)t.s(e.clone())})).catch((e=>{for(let t of l)t.e(e)})).then((()=>(c.delete(r),e)))),f=i(s);if(f){let t=`https://${s.host}${s.pathname}`;t.endsWith("/index.html")&&(t=t.substring(0,t.length-10)),f.search&&(t+=s.search),u(caches.match(t).then((s=>s??a(n,!0).then((n=>{if(h(n)){const s=n.clone();caches.open(e).then((e=>e.put(t,s)))}return n})))))}else{const e=o(n.url);u(e?a(n,!1,e):fetch(n).catch((e=>new Response(e,{status:499}))))}})),self.addEventListener("message",(e=>{"update"===e.data&&l().then((t=>e.source.postMessage({type:"update",update:t.list,version:t.version,old:t.old})))}));const i=e=>{if("localhost"!==e.hostname)for(let t in r){const n=r[t];if(n.match(e))return n}},l=()=>{const r=e=>s().then((t=>{const{info:s,global:r}=e,o={global:r,local:s[0].version,escape:t?.escape??0};if(!t)return n(o),{version:o,old:t};let a=new u,h=((e,t,n)=>{for(let s of t){const{version:t,change:r}=s;if(t===n)return!1;if(r)for(let t of r)e.push(new f(t))}return!0})(a,s,t.local);return n(o),h&&(r!==t.global?a.force=!0:a.refresh=!0),{list:a,version:o,old:t}}));return a(new Request("/update.json"),!1).then((n=>{if(h(n))return n.json().then((n=>r(n).then((n=>{const s={version:n.version,old:n.old};return n.list?(r=n.list,caches.open(e).then((e=>e.keys().then((n=>Promise.all(n.map((async n=>{const s=n.url;return s!==t&&r.match(s)?(e.delete(n),s):null}))))).then((e=>e.filter((e=>e))))))).then((e=>0===e.length?null:e)).then((e=>Object.assign({list:e},s))):s;var r}))));throw`加载 update.json 时遇到异常，状态码：${n.status}`}))};function u(){const e=[];this.push=t=>{e.push(t)},this.match=t=>{if(this.force)return!0;if(t=new URL(t),this.refresh)return i(t).clean;for(let n of e)if(n.match(t))return!0;return!1}}function f(e){const t=t=>{const n=e.value;if(Array.isArray(n)){for(let e of n)if(t(e))return!0;return!1}return t(n)};this.match=(()=>{switch(e.flag){case"html":return e=>e.pathname.match(/(\/|\.html)$/);case"end":return e=>t((t=>e.href.endsWith(t)));case"begin":return e=>t((t=>e.pathname.startsWith(t)));case"str":return e=>t((t=>e.href.includes(t)));case"reg":return e=>t((t=>e.href.match(new RegExp(t,"i"))));default:throw`未知表达式：${JSON.stringify(e)}`}})()}})();