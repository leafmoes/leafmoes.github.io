const this_Domain=new URL(self.location.href).host;function CacheDB(e,t){this.namespace=e||"CacheDBDefaultNameSpace",this.prefix=t||"CacheDBDefaultPrefix",this.read=async function(e,t){return t=t||{type:"text"},new Promise(((n,a)=>{caches.open(this.namespace).then((a=>{a.match(new Request(`https://${this.prefix}/${encodeURIComponent(e)}`)).then((e=>{switch(t.type){case"json":return void n(e.json());case"arrayBuffer":return void n(e.arrayBuffer());case"blob":return void n(e.blob());default:return void n(e.text())}})).catch((e=>{n(null)}))}))}))},this.write=async function(e,t,n){return n=n||{type:"text"},new Promise(((a,i)=>{caches.open(this.namespace).then((i=>{i.put(new Request(`https://${this.prefix}/${encodeURIComponent(e)}`),new Response(t,{headers:{"Content-Type":(()=>{switch(n.type){case"json":return"application/json";case"arrayBuffer":case"blob":return"application/octet-stream";default:return"text/plain"}})()}})).then(a(!0)).catch((e=>{a(!1)}))}))}))},this.readWithDefault=async function(e,t,n){const a=await this.read(e,n);return a||await this.write(e,t,n),a||t},this.delete=async function(e){return new Promise(((t,n)=>{caches.open(this.namespace).then((n=>{n.delete(new Request(`https://${this.prefix}/${encodeURIComponent(e)}`)).then(t(!0)).catch((e=>{t(!1)}))}))}))}}self.cons={s:e=>{console.log(`%c[SUCCESS]%c ${e}`,"color:white;background:green;","")},w:e=>{console.log(`%c[WARNING]%c ${e}`,"color:brown;background:yellow;","")},i:e=>{console.log(`%c[INFO]%c ${e}`,"color:white;background:blue;","")},e:e=>{console.log(`%c[ERROR]%c ${e}`,"color:white;background:red;","")},d:e=>{console.log(`%c[DEBUG]%c ${e}`,"color:white;background:black;","")}};const db=new CacheDB("CyanAcc","CyanAccDB"),parallel_fetch=async(e,t)=>new Promise(((n,a)=>{const i=new Event("abortOtherInstance"),o=new EventTarget,s=setTimeout((()=>{n([new Response("504 All GateWays Failed,CyanAcc Returned",{status:504,statusText:"504 All Gateways Timeout"})])}),t.timeoutL2);try{Promise.any(e.map((async e=>{let t=new AbortController,a=!1;o.addEventListener(i.type,(()=>{a||t.abort()})),fetch(e,{signal:t.signal,mode:new URL(e.url).host===this_Domain?"same-origin":"cors",redirect:"follow"}).then((t=>{200===t.status&&(a=!0,o.dispatchEvent(i),clearTimeout(s),n([t.clone(),e]))})).catch((e=>{"DOMException: The user aborted a request."==e&&console.log()}))})))}catch(e){n([new Response("504 All GateWays Failed,CyanAcc Returned",{status:504,statusText:"504 All Gateways Timeout"})])}}));function AssetsFetchWithCache(e,t,n){this.namespace="AssetsCache",this.urls=t,this.origin=e,n.origin&&t.push({url:e.url,weight:0,id:-1}),this.CacheConfig=n,this.IntelligentFetch=async function(){if(this.CacheConfig.parallel){let t=[new Response("IntelligentFetch Tried To Fetch:"+e.url,{status:500})];for(;200!==t[0].status;){const n=this.urls.slice(0,this.CacheConfig.threads);if(t=await parallel_fetch(n.map((t=>this.rebuild.request(e,t.url))),this.CacheConfig),200===t[0].status){this.urls.map((async e=>{if(e.url===t[1].url){if(!CDN_Domain[e.id])return;CDN_Domain[e.id].weight++,await db.write("CDN_Domain",JSON.stringify(CDN_Domain))}}));break}if(this.urls=this.urls.slice(this.CacheConfig.threads),0===this.urls.length)break}return t}return fetch(e)},this.rebuild={response:e=>new Response(e.body,{headers:{...e.headers,"Cache-Control":"CyanAcc","Cache-Time":(new Date).getTime(),"Cache-L1":this.CacheConfig.cacheL1,"Cache-L2":this.CacheConfig.cacheL2},...e}),request:(e,t)=>new Request(t||e,{headers:e.headers,mode:"navigate"===e.mode?"same-origin":e.mode,...e})},this.fetch=async function(t=!1){return t?(await this.IntelligentFetch())[0]:new Promise((async(t,n)=>{const a=await caches.open(this.namespace),i=await a.match(new Request(this.origin.url)),o=async()=>{const e=(await this.IntelligentFetch())[0];return 200===e.status&&await a.put(new Request(this.origin.url),this.rebuild.response(e.clone())),e};if(i){if("CyanAcc"!==i.headers.get("Cache-Control"))return cons.w(`${e.url} Cannot Be Refreshed Because It Is Not A CyanAcc Cache`),void t(i);const n=(new Date).getTime()-Number(i.headers.get("Cache-Time"));n>this.CacheConfig.cacheL1?(cons.i(`${e.url} Is Expired L1,Refreshing...`),n>this.CacheConfig.cacheL2?(cons.i(`${e.url} Is Expired L2,Force Refreshing...`),t(await o())):t(Promise.any([o(),new Promise((async e=>{setTimeout((async()=>{e(i.clone())}),this.CacheConfig.timeoutL1)}))]))):t(i)}else t(await o())}))}}const Default_CDN_Fetch_Config={enable:!0,parallel:!0,ignore_search:!0,threads:4,origin:!0,timeoutL1:2e3,timeoutL2:5e3,cache:!0,cacheL1:6048e5,cacheL2:2592e6},Default_Blog_Fetch_Config={enable:!0,parallel:!0,origin:!1,ignore_search:!1,mirrors:[{type:"npm",PACKAGE_NAME:"blog-artmoe",PACKAGE_VERSION:"0.0.0-1700630192",weight:5}],threads:2,timeoutL1:2e3,timeoutL2:5e3,cache:!0,cacheL1:36e5,cacheL2:864e5},Default_Blog_Domain=["blog.artmoe.top","localhost:4000"],Default_CDN_Domain=[{match:"(cdn|fastly).jsdelivr.net",domain:"cdn.jsdelivr.net",concat:{npm:"/npm/{{PACKAGE_NAME}}@{{PACKAGE_VERSION}}/{{FILE_PATH}}",github:"/gh/{{USER_NAME}}/{{REPO_NAME}}/{{FILE_PATH}}"},weight:0},{match:"cdnjs.cloudflare.com",domain:"cdnjs.cloudflare.com",concat:{cdnjs:"/ajax/libs/{{PACKAGE_NAME}}/{{PACKAGE_VERSION}}/{{FILE_PATH}}"},weight:0},{match:"cdn.bootcdn.net",domain:"cdn.bootcdn.net",concat:{cdnjs:"/ajax/libs/{{PACKAGE_NAME}}/{{PACKAGE_VERSION}}/{{FILE_PATH}}"},weight:0},{match:"unpkg.com",domain:"unpkg.com",concat:{npm:"/{{PACKAGE_NAME}}@{{PACKAGE_VERSION}}/{{FILE_PATH}}"},weight:1},{match:"cdn.staticfile.org",domain:"cdn.staticfile.org",concat:{cdnjs:"/ajax/libs/{{PACKAGE_NAME}}/{{PACKAGE_VERSION}}/{{FILE_PATH}}"},weight:0},{match:"lib.baomitu.com",domain:"lib.baomitu.com",concat:{cdnjs:"/ajax/libs/{{PACKAGE_NAME}}/{{PACKAGE_VERSION}}/{{FILE_PATH}}"},weight:2},{match:"npm.elemecdn.com",domain:"npm.elemecdn.com",concat:{npm:"/{{PACKAGE_NAME}}@{{PACKAGE_VERSION}}/{{FILE_PATH}}"},weight:3},{match:"unpkg.zhimg.com",domain:"unpkg.zhimg.com",concat:{npm:"/{{PACKAGE_NAME}}@{{PACKAGE_VERSION}}/{{FILE_PATH}}"},weight:-1},{match:"registry.npmmirror.com",domain:"registry.npmmirror.com",concat:{npm:"/{{PACKAGE_NAME}}/{{PACKAGE_VERSION}}/files/{{FILE_PATH}}"},weight:10}];function CDNObject(e){if(this.valid=!1,"string"!=typeof e&&typeof e!=typeof new URL(""))throw new Error("Invalid URL");if(this.url=e,this.urlObject=new URL(e),this.id=CDN_Domain.findIndex((t=>new RegExp(t.match).test(e))),-1===this.id)throw new Error("CDN Not Found:"+e);for(var t in CDN_Domain[this.id].concat)if(e.replace("https://"+CDN_Domain[this.id].domain,"").startsWith(CDN_Domain[this.id].concat[t].split("{{")[0])){this.type=t;break}if(this.domain=CDN_Domain[this.id].domain,!this.type)throw new Error("CDN Prefix Not Found:"+e);const n=e.match(new RegExp(CDN_Domain[this.id].concat[this.type].replace("{{PACKAGE_NAME}}","(?<PACKAGE_NAME>(@[^/]+/[^/]+)|([^/]+))").replace("/{{FILE_PATH}}","(/(?<FILE_PATH>.+)|)").replace(/\{\{(.*?)\}\}/g,"(?<$1>[^/]+)").replace(/\//g,"\\/")));for(var a in this.var=n.groups,this.var)void 0===this.var[a]&&(this.var[a]="");this.valid=!0,this.generate_mirror=function(e){const t=CDN_Domain.findIndex((t=>t.domain===e));if(-1===t)throw new Error("CDN Mirror Not Found");if(!CDN_Domain[t].concat[this.type])throw new Error("This Mirror Has No Such Prefix: "+this.type+" ,It only has:"+Object.keys(CDN_Domain[t].concat).join(","));let n=`https://${CDN_Domain[t].domain}${CDN_Domain[t].concat[this.type]}`;for(var a in this.var)n=n.replace(`{{${a}}}`,this.var[a]);return new CDNObject(n)},this.get_all_mirrors=function(){const e=[];for(var t in CDN_Domain)CDN_Domain[t].concat[this.type]&&e.push({id:t,domain:CDN_Domain[t].domain,weight:CDN_Domain[t].weight});return e}}(async()=>{self.Blog_Domain=JSON.parse(await db.readWithDefault("Blog_Domain",JSON.stringify(Default_Blog_Domain))),self.Blog_Fetch_Config=JSON.parse(await db.readWithDefault("Blog_Fetch_Config",JSON.stringify(Default_Blog_Fetch_Config))),self.CDN_Domain=JSON.parse(await db.readWithDefault("CDN_Domain",JSON.stringify(Default_CDN_Domain))),self.CDN_Fetch_Config=JSON.parse(await db.readWithDefault("CDN_Fetch_Config",JSON.stringify(Default_CDN_Fetch_Config)))})(),addEventListener("fetch",(e=>{try{e.respondWith(handleRequest(e.request))}catch(t){return void e.respondWith(new Response("Cyan Acc Err!"))}})),addEventListener("install",(function(){self.skipWaiting()})),addEventListener("activate",(function(){self.clients.claim()}));const handleRequest=async e=>{const t=new URL(e.url).host;if(Blog_Domain.includes(t))return BlogRouter(e);for(var n of CDN_Domain)if(e.url.match(new RegExp(n.match)))return CDNRouter(e);return fetch(e)},BlogRouter=async e=>new URL(e.url).pathname.startsWith("/CyanAcc")?CyanAccRouter(e):fetch(e),CDNRouter=async e=>{if(e=new Request(e.url.replace(/^http\:/g,"https:"),e),!CDN_Fetch_Config.enable)return fetch(e);const t=new CDNObject(e.url);if(!t.valid)return fetch(e);const n=t.get_all_mirrors().sort(((e,t)=>t.weight-e.weight));return new AssetsFetchWithCache(t,n.map((e=>({url:t.generate_mirror(e.domain).url,weight:e.weight,id:e.id}))),CDN_Fetch_Config).fetch()},CyanAccRouter=async e=>{switch(new URL(e.url).pathname.replace("/CyanAcc","")){case"":return Response.redirect("/CyanAcc/");case"/":return new Response("This Page Was Provided By CyanAcc");case"/api":return(async e=>{if("POST"!==e.method)return new Response("Method Not Allowed",{status:405});const t=await e.text();try{JSON.parse(t)}catch(e){return new Response("Bad Request",{status:400})}return"PING"===JSON.parse(t).action?new Response("PONG"):new Response("Bad Request",{status:400})})(e);default:return new Response("404 Not Found",{status:404})}};